%%
%% Tikz styles used for diagrams
%%

\tikzstyle{every node}+=[font=\footnotesize]

\tikzstyle{dropshadow} = [blur shadow={shadow blur steps=5,shadow xshift=.0ex,
                                       shadow yshift=-0.3ex,opacity=0.9,
                                       shadow blur radius=0.5ex}]

\tikzstyle{compound} = [rectangle, draw, text centered,
                         rounded corners,
                         top color=white,
                         bottom color=black!5,
                         dropshadow,
                         draw=black!10]

\tikzstyle{component} = [compound, draw=black!70]

\tikzstyle{compoundlabel} = [below right,
                             text opacity=0.6, inner sep=0, outer sep=0.7ex]

\tikzstyle{capability} = [circle, draw, fill, thick,
                          inner color=white,
                          outer color=blue!30,
                          inner sep=1pt,
                          minimum size=2.8ex,
                          fill opacity=1.0, dropshadow,
                          anchor=mid]

\tikzstyle{capslot} = [minimum size=2.5ex, inner sep=0ex, outer sep=0ex,
                       fill=white, draw=black!70]

\tikzstyle{kernelobj} = [draw, tape, tape bend top=none,
                         draw=black!70, align=center, fill=white, dropshadow]

\tikzstyle{arrow} = [draw=black!80, ->, >= stealth, sloped, above]

\tikzstyle{userland} = [fill=green]

\tikzstyle{kernel} = [fill=yellow]

\tikzstyle{thread} = [font=\normalsize]

\tikzstyle{nodecompound} = [rectangle, draw, align=center,
                            minimum height=2em, minimum width=2em,
                            inner sep=1.5ex, outer sep=1ex,
                            rounded corners,
                            top color=white,
                            bottom color=black!20,
                            dropshadow,
                            draw=black!10, thick]

\tikzstyle{ownership} = [draw, single arrow, draw=black!10, minimum height=4ex,
                         bottom color=white, top color=red!70,
                         single arrow head extend=1ex]

\tikzstyle{every picture}+=[remember picture]

\newcommand\kernelred{black!20!red!100}


%%
%% Functions for constructing Tikz nodes
%%

%%
% Create capability space node
%
% argument 1: node name, also used as prefix for the individual slots
% argument 2: maximum index
% argument 3: node arguments
%
% Uses tikz style "capslot"
%
\newcommand\capspacenode[3]{
	\node[#3] (#1) {
		\begin{tikzpicture}
			\begin{scope}[start chain,node distance=0,rounded corners=0]
				\foreach \i in {0,1,...,#2} {
					\node [on chain,capslot,draw] (#1\i) {};
					\path (#1\i) node[yshift=0.5ex, xshift=-0.5ex, inner sep=0.5ex,
					                  text=black!60] {\tiny \i};
				}
				\node [on chain,capslot, fill=none, draw=none, outer sep=0.5ex] {$\ldots$};
			\end{scope}
		\end{tikzpicture}
	};
}


%%
% Create RPC object node
%
% argument 1: node name, also used as prefix for the individual slots
% argument 2: node arguments
% argument 3: capability name
% argument 4: node content
% argument 5: capability node arguments
%
% The capability node will be named #1cap.
% The object node will be named #1obj.
%
\newcommand\rpcobjectnodebase[5] {
	\node[#2] (#1) {
		\begin{tikzpicture}
			\node [draw, left color=blue!20, right color=white, minimum size=0pt,
			       thick, inner sep=1ex, rounded corners=0.5ex, dropshadow]
			       (#1obj) {#4};
			\node [outer sep=0pt, capability, #5]
			       (#1cap) {#3};
			\path [draw, dropshadow, very thick] (#1cap) -- node (#1link) {} (#1obj);
		\end{tikzpicture}
	};
}


%%
% Create RPC object node with the capability to the right of the object
%
% The four arguments are the same as for 'rpcobjectnodebase'.
%
\newcommand\rpcobjectrnode[4] {
	\rpcobjectnodebase{#1}{#2}{#3}{#4}{right=1.5ex of #1obj} }


%%
% Create RPC object node with the capability to the left of the object
%
% The four arguments are the same as for 'rpcobjectnodebase'.
%
\newcommand\rpcobjectlnode[4] {
	\rpcobjectnodebase{#1}{#2}{#3}{#4}{left=1.5ex of #1obj} }


%%
% Create compounding node
%
% argument 1:  node name
% argument 2:  node style
% argument 3:  node content
%
\newcommand\compoundnode[3] {
	\node[#2] (#1) {
		\begin{tikzpicture}[xshift=0, yshift=0, outer sep=0, inner sep=0]
			#3
		\end{tikzpicture}
	};
}


%%
% Create labeled compounding box node
%
% argument 1:  node name
% argument 2:  node style
% argument 3:  label to appear at the north-west corner
% argument 4:  content of the box
%
\newcommand\labeledcompoundnode[4] {
	\compoundnode{#1}{inner sep=3ex, #2}{#4}
	\path (#1.north west) node[compoundlabel] {#3};
}


%%
% Create kernel-user boundary
%
% argument 1:  nodes that are contained in the kernel,
%              specified as tikz style, e.g., 'fit=(node1) (node2)...'
%
\newcommand\kernelboundary[1] {
	\node [inner sep=4ex, #1] (kernelboundary) {};
	\draw [dashed, very thick, color=\kernelred] (kernelboundary.north west)
	      -- (kernelboundary.north east)
	      node[below left] {kernel};
}


%%
% Create node for an upward pointing thread
%
% argument 1:  node name
% argument 2:  node style
%
\newcommand\upwardthreadnode[2] {
	\node [thread, #2] (#1) {$\uplsquigarrow$}; }


%%
% Create node for an downward pointing thread
%
% argument 1:  node name
% argument 2:  node style
%
\newcommand\downwardthreadnode[2] {
	\node [thread, #2] (#1) {$\downrsquigarrow$}; }


%%
% Create entrypoint node
%
% argument 1:  node name
% argument 2:  node style
% argument 3:  component where the entrypoint resides
%
% The command creates sub nodes for the semicircle called #1ep and the
% thread called #1thread.
%
\newcommand\entrypointnode[3]{
	\node [above, inner sep=0, outer sep=0, #2] at (#3.south) (#1) {
		\begin{tikzpicture}

			\node [draw=black, draw opacity=0.4, ball color=blue, fill opacity=0.2,
			       rounded corners=0, shape=semicircle,
			       inner sep=1.3ex, outer sep=0, above]
			(#1ep) {};

			\path (#1ep.arc end) node[compoundlabel, right, yshift=1ex] {EP};

			\path (#1ep.arc start) [thread]
				node [left, xshift=-0.3ex, yshift=1ex] (#1thread) {$\uplsquigarrow$};

		\end{tikzpicture}
	};
}


\newcommand\capability[1]{
	\begin{tikzpicture}[baseline=-0.6ex]
	\node [capability] {#1};
	\end{tikzpicture}
}
